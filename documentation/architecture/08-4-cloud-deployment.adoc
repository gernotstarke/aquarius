=== Cloud Deployment

==== Ãœberblick

Das Aquarius-System wird als Cloud-Native-Anwendung auf **fly.io** bereitgestellt. Dies ermÃ¶glicht eine kostengÃ¼nstige, skalierbare und wartungsarme Infrastruktur fÃ¼r Kunstschwimm-WettkÃ¤mpfe.

*Deployment-Zielarchitektur:*

----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  arqua42.arc42.org                       â”‚
â”‚                    (Custom Domain)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    fly.io Platform                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚      Aquarius App Container            â”‚             â”‚
â”‚  â”‚  (Frontend + Backend + Static Files)   â”‚             â”‚
â”‚  â”‚                                         â”‚             â”‚
â”‚  â”‚  Port 8080:                             â”‚             â”‚
â”‚  â”‚  â€¢ FastAPI Backend (/)                  â”‚             â”‚
â”‚  â”‚  â€¢ React Frontend (static build)        â”‚             â”‚
â”‚  â”‚  â€¢ Static Assets (/static)              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚             â”‚                                            â”‚
â”‚             â”‚ libSQL Protocol                            â”‚
â”‚             â”‚ (over HTTP/WebSocket)                      â”‚
â”‚             â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         Turso Database                 â”‚             â”‚
â”‚  â”‚         (libSQL Cloud)                 â”‚             â”‚
â”‚  â”‚                                         â”‚             â”‚
â”‚  â”‚  â€¢ Managed SQLite Database              â”‚             â”‚
â”‚  â”‚  â€¢ Edge Replication (optional)          â”‚             â”‚
â”‚  â”‚  â€¢ Automatic Backups                    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

==== Technologie-Stack fÃ¼r Cloud Deployment

[cols="1,2,2"]
|===
|Komponente |Technologie |BegrÃ¼ndung

|Container-Platform
|**fly.io**
|â€¢ Einfaches Deployment mit `flyctl`
â€¢ Automatisches HTTPS/TLS
â€¢ Integriertes Load Balancing
â€¢ Globale Edge-Locations
â€¢ Kostenlose Tier fÃ¼r kleine Apps

|Datenbank
|**Turso (libSQL)**
|â€¢ Managed SQLite-as-a-Service
â€¢ SQLAlchemy-kompatibel Ã¼ber libSQL-Treiber
â€¢ Edge-Replication fÃ¼r niedrige Latenz
â€¢ Automatische Backups
â€¢ Kostenlose Tier (500 MB, 1 Mrd. Row Reads/Monat)

|Application Server
|**uvicorn**
|â€¢ ASGI-Server fÃ¼r FastAPI
â€¢ Hohe Performance
â€¢ WebSocket-Support

|Static File Serving
|**FastAPI StaticFiles**
|â€¢ Direkt aus Container
â€¢ Alternative: fly.io Volumes fÃ¼r grÃ¶ÃŸere Mengen

|Domain & SSL
|**Custom Domain + fly.io SSL**
|â€¢ arqua42.arc42.org
â€¢ Automatische TLS-Zertifikate (Let's Encrypt)
|===

==== Deployment-Region (Initial)

Frankfurt (fra) oder Amsterdam (ams) fÃ¼r niedrige Latenz in Deutschland/Europa

----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          fly.io Region: fra              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Aquarius Instance        â”‚          â”‚
â”‚  â”‚   â€¢ 1 VM (shared-cpu-1x)   â”‚          â”‚
â”‚  â”‚   â€¢ 256 MB RAM             â”‚          â”‚
â”‚  â”‚   â€¢ 1 GB Disk              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                 â”‚                         â”‚
â”‚                 â”‚ libSQL/HTTP             â”‚
â”‚                 â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Turso Database           â”‚          â”‚
â”‚  â”‚   â€¢ Primary Location: fra  â”‚          â”‚
â”‚  â”‚   â€¢ 500 MB Storage         â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

[NOTE]
====
*Skalierung fÃ¼r spÃ¤tere Phasen:*

* **Multi-Region Deployment:** Replicas in mehreren Regionen
* **Database Replication:** Turso Edge-Replicas fÃ¼r globale VerfÃ¼gbarkeit
* **Auto-Scaling:** Fly.io Autoscaling basierend auf Traffic
====

==== Container-Strategie

===== Dockerfile-Architektur

*Multi-Stage Build fÃ¼r optimale Image-GrÃ¶ÃŸe:*



===== Static File Serving

Frontend wird als **statische Build-Artefakte** in den Container integriert:

[source,python]
----
# backend/app/main.py (Cloud-Konfiguration)
import os
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from pathlib import Path

app = FastAPI()

# Serve React Frontend (Cloud)
if os.getenv("FLY_APP_NAME"):  # Production auf fly.io
    frontend_dist = Path(__file__).parent.parent.parent / "frontend" / "dist"

    # API routes unter /api
    app.include_router(router, prefix="/api")

    # Static assets (JS, CSS, Images)
    app.mount("/assets", StaticFiles(directory=str(frontend_dist / "assets")), name="assets")

    # Figuren-Bilder
    app.mount("/static", StaticFiles(directory=str(frontend_dist / "static")), name="static")

    # SPA fallback: Alle anderen Routes â†’ index.html
    @app.get("/{full_path:path}")
    async def serve_spa(full_path: str):
        return FileResponse(frontend_dist / "index.html")
----

==== Datenbank-Migration: SQLite â†’ Turso

===== Turso Connection String

[source,python]
----
# backend/app/database.py
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# Cloud: Turso libSQL
# Local: SQLite File
DATABASE_URL = os.getenv(
    "DATABASE_URL",
    "sqlite:///./database/arqua42.db"  # Fallback fÃ¼r lokale Entwicklung
)

# Turso Format: libsql://[db-name]-[org].turso.io?authToken=...
engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False} if "sqlite" in DATABASE_URL else {},
    echo=False
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
----


==== Umgebungsvariablen und Secrets

===== fly.io Secrets Management

Secrets werden mit `flyctl secrets` verwaltet, **nicht** in `fly.toml`:

[source,bash]
----
# Turso Database URL mit Auth-Token
flyctl secrets set DATABASE_URL="libsql://aquarius-abc123.turso.io?authToken=eyJ..."

# Weitere Secrets (optional)
flyctl secrets set SECRET_KEY="$(openssl rand -base64 32)"
flyctl secrets set ADMIN_PASSWORD="..."
----

===== Umgebungsvariablen in fly.toml

[source,toml]
----
# fly.toml
app = "aquarius-production"
primary_region = "fra"

[build]
  dockerfile = "Dockerfile"

[env]
  # Ã–ffentliche Konfiguration (keine Secrets!)
  ENVIRONMENT = "production"
  LOG_LEVEL = "info"
  PORT = "8080"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1

[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 256
----

[WARNING]
====
*Niemals Secrets in `fly.toml` committen!*

Verwende immer `flyctl secrets set` fÃ¼r sensible Daten.
====

==== Deployment-Workflow

===== Automatisches Deployment (CI/CD)

*GitHub Actions Workflow:*

[source,yaml]
----
name: Deploy to fly.io

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
----

===== Manuelles Deployment

[source,bash]
----
# 1. Login bei fly.io
flyctl auth login

# 2. App erstellen (einmalig)
flyctl launch --name aquarius-production --region fra

# 3. Secrets konfigurieren (einmalig)
flyctl secrets set DATABASE_URL="libsql://..."

# 4. Deploy durchfÃ¼hren
make deploy-to-fly

# 5. Status prÃ¼fen
flyctl status
flyctl logs
----

==== Makefile fÃ¼r Deployment

[source,makefile]
----
.PHONY: deploy-to-fly
deploy-to-fly: ## Deploy application to fly.io
	@echo "ğŸš€ Deploying to fly.io..."
	@echo ""
	@echo "Prerequisites:"
	@echo "  - flyctl installed (brew install flyctl)"
	@echo "  - Logged in (flyctl auth login)"
	@echo "  - Secrets configured (flyctl secrets list)"
	@echo ""
	@read -p "Continue with deployment? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		flyctl deploy --remote-only; \
	else \
		echo "âŒ Deployment cancelled"; \
		exit 1; \
	fi

.PHONY: deploy-status
deploy-status: ## Check fly.io deployment status
	@flyctl status
	@echo ""
	@flyctl logs --lines 50

.PHONY: deploy-logs
deploy-logs: ## Show fly.io application logs
	flyctl logs

.PHONY: deploy-ssh
deploy-ssh: ## SSH into fly.io container
	flyctl ssh console
----

===== Turso Database Monitoring

[source,bash]
----
# Turso CLI installieren
brew install tursodatabase/tap/turso

# Database Status
turso db show aquarius-production

# Query Statistics
turso db stats aquarius-production
----

==== 8.4.11 Backup und Disaster Recovery

===== Turso Automatic Backups

* **Point-in-Time Recovery:** Automatisch fÃ¼r letzte 24-48h
* **Manual Snapshots:** Vor grÃ¶ÃŸeren Ã„nderungen

[source,bash]
----
# Manual Backup erstellen
turso db dump aquarius-production --output backup.sql

# Restore aus Backup
turso db restore aquarius-production --from backup.sql
----

===== Container Volumes (fÃ¼r Figuren-Bilder)

*Optional: Persistentes Volume fÃ¼r Upload-Bilder:*

[source,toml]
----
# fly.toml
[mounts]
  source = "aquarius_data"
  destination = "/app/data"
----

[source,bash]
----
# Volume erstellen
flyctl volumes create aquarius_data --region fra --size 1

# Backup von Volume
flyctl ssh sftp get -r /app/data ./local-backup/
----

==== Kosten-Kalkulation

===== fly.io Pricing (Stand Dezember 2025)

[cols="1,1,2"]
|===
|Ressource |Menge |Kosten/Monat

|**Shared CPU VM**
|1x (256 MB RAM)
|~$3-5

|**Persistentes Volume**
|1 GB
|~$0.15

|**Outbound Traffic**
|~10 GB
|Inkludiert

|**Custom Domain + SSL**
|1 Domain
|Kostenlos
|===

*GeschÃ¤tzte Gesamtkosten:* **$5-10 / Monat** fÃ¼r kleine bis mittlere Nutzung



===== GitHub Secrets Setup

====== 1. API Tokens erstellen

*fly.io API Token:*

[source,bash]
----
# Interaktiv
flyctl auth token

# Output: FlyV1 fm2_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
----

*Turso Auth Tokens (getrennt fÃ¼r Staging & Production):*

[source,bash]
----
# Turso Login
turso auth login

# Staging Database Token
turso db tokens create aquarius-staging --expiration none
# Output: eyJhbGc...

# Production Database Token
turso db tokens create aquarius-production --expiration none
# Output: eyJhbGc...
----

===== Turso Database Setup

====== Datenbanken erstellen

[source,bash]
----
# Staging Database
turso db create aquarius-staging --location fra
turso db show aquarius-staging

# Connection URL kopieren
# Beispiel: libsql://aquarius-staging-abc123.turso.io

# Production Database
turso db create aquarius-production --location fra
turso db show aquarius-production

# Connection URL kopieren
# Beispiel: libsql://aquarius-production-xyz789.turso.io
----

====== Secrets in fly.io setzen

[source,bash]
----
# Staging
flyctl secrets set \
  DATABASE_URL="libsql://aquarius-staging-abc123.turso.io?authToken=eyJhbGc..." \
  --app aquarius-staging

# Production
flyctl secrets set \
  DATABASE_URL="libsql://aquarius-production-xyz789.turso.io?authToken=eyJhbGc..." \
  --app aquarius-production
----

====== Daten von Staging â†’ Production kopieren (optional)

[source,bash]
----
# Staging Dump erstellen
turso db dump aquarius-staging --output staging-backup.sql

# In Production importieren (VORSICHT!)
turso db restore aquarius-production --from staging-backup.sql
----


====== fly.io Zertifikate

[source,bash]
----
# Staging
flyctl certs create staging.arqua42.arc42.org --app aquarius-staging

# Production
flyctl certs create arqua42.arc42.org --app aquarius-production

# Status prÃ¼fen
flyctl certs list --app aquarius-staging
flyctl certs list --app aquarius-production
----

==== Sicherheitsaspekte

==== DB/Schema Migrationen 

Technologie: Alembic

[source,bash]
----
# Lokale Migration testen
cd backend
alembic upgrade head

# Cloud Migration durchfÃ¼hren (manuell)
flyctl ssh console
cd /app/backend
alembic upgrade head
----

[IMPORTANT]
====
*Zero-Downtime Migrations:*

1. **Backward-Compatible Changes:** Neue Spalten als nullable
2. **Blue-Green Deployment:** Alte Version lÃ¤uft wÃ¤hrend Migration
3. **Rollback-Plan:** Jede Migration muss `downgrade()` haben
====

==== Rollback-Strategie

fly.io Release Management

[source,bash]
----
# Releases anzeigen
flyctl releases

# Rollback zur vorherigen Version
flyctl releases rollback

# Rollback zu spezifischer Version
flyctl releases rollback --version v123
----

===== Database Rollback

[source,bash]
----
# Alembic Downgrade (lokal testen!)
alembic downgrade -1

# Im Notfall: Turso Point-in-Time Restore
turso db restore aquarius-production --timestamp "2024-01-15T10:00:00Z"
----

==== Entwicklungs-Workflow

===== Lokale Entwicklung mit Turso

[source,bash]
----
# Turso CLI installieren
brew install tursodatabase/tap/turso

# Turso Auth Token holen
turso db tokens create aquarius-dev

# In .env setzen
DATABASE_URL="libsql://aquarius-dev.turso.io?authToken=..."

# App starten
make dev
----


* fly.io Docs: https://fly.io/docs/
* Turso Docs: https://docs.turso.tech/
* libSQL Python Client: https://github.com/libsql/libsql-client-py
====
