version: '3.8'

services:
  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    image: aquarius-docs:latest
    volumes:
      - ./docs:/docs
    working_dir: /docs
    command: ["bash", "-c", "echo 'Aquarius Documentation Build Environment Ready'"]

  # Service for generating diagrams
  docs-diagrams:
    image: aquarius-docs:latest
    volumes:
      - ./docs:/docs
    working_dir: /docs
    command: >
      bash -c "
      mkdir -p build/images &&
      plantuml -tpng -o ../../../../build/images src/architecture/images/puml/*.puml &&
      echo '✓ Diagrams generated in build/images/'
      "

  # Service for generating HTML
  docs-html:
    image: aquarius-docs:latest
    volumes:
      - ./docs:/docs
    working_dir: /docs
    command: >
      bash -c "
      mkdir -p build &&
      asciidoctor src/arqua42-architecture.adoc
      -o build/arqua42-architecture.html
      -a toc=left
      -a toclevels=3
      -a sectnums
      -a icons=font
      -a imagesdir=images
      -r asciidoctor-diagram &&
      echo '✓ HTML generated in build/arqua42-architecture.html'
      "

  # Service for generating PDF
  docs-pdf:
    image: aquarius-docs:latest
    volumes:
      - ./docs:/docs
    working_dir: /docs
    command: >
      bash -c "
      mkdir -p build &&
      asciidoctor-pdf src/arqua42-architecture.adoc
      -o build/arqua42-architecture.pdf
      -a sectnums
      -a imagesdir=images
      -r asciidoctor-diagram &&
      echo '✓ PDF generated in build/arqua42-architecture.pdf'
      "

  # Service for watching and rebuilding
  docs-watch:
    image: aquarius-docs:latest
    volumes:
      - ./docs:/docs
    working_dir: /docs
    command: >
      bash -c "
      echo 'Watching for changes in src/...' &&
      while true; do
        inotifywait -r -e modify,create,delete src/ 2>/dev/null &&
        echo 'Change detected, rebuilding...' &&
        mkdir -p build &&
        asciidoctor src/arqua42-architecture.adoc
        -o build/arqua42-architecture.html
        -a toc=left
        -a toclevels=3
        -a sectnums
        -a icons=font
        -a imagesdir=images
        -r asciidoctor-diagram
      done
      "
