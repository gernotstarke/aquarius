services:
  jekyll:
    container_name: aquarius-website
    image: bretfisher/jekyll-serve
    volumes:
      - .:/site
      - bundle_cache:/usr/local/bundle
    ports:
      - '4000:4000'
      - '35729:35729'
    command: bundle exec jekyll serve --host 0.0.0.0 --livereload --force_polling

  obfuscate:
    container_name: aquarius-website-obfuscate
    image: node:20-alpine
    volumes:
      - .:/site
    working_dir: /site
    command: ["sh", "-c", "npm install -g terser && terser assets/js/password-protect.js --compress --mangle --mangle-props regex=/^_/ --output assets/js/password-protect.min.js && echo 'âœ… Obfuscated password-protect.js'"]

  compile-adrs:
    container_name: aquarius-website-compile-adrs
    image: alpine:latest
    volumes:
      - ../documentation/adr:/source:ro
      - ./_adrs:/output
      - ./scripts:/scripts:ro
    command: ["sh", "/scripts/compile-adrs.sh"]

  compile-arc42:
    container_name: aquarius-website-compile-arc42
    image: asciidoctor/docker-asciidoctor
    volumes:
      - ../documentation/architecture:/source:ro
      - ../documentation/architecture/images:/source/images:ro
      - ./_pages/architecture:/output
      - ./scripts:/scripts:ro
    command: ["sh", "/scripts/compile-arc42.sh"]

volumes:
  bundle_cache:
