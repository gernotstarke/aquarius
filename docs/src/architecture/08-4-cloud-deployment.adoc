=== 8.4 Cloud Deployment

==== 8.4.1 √úberblick

Das Aquarius-System wird als Cloud-Native-Anwendung auf **fly.io** bereitgestellt. Dies erm√∂glicht eine kosteng√ºnstige, skalierbare und wartungsarme Infrastruktur f√ºr Kunstschwimm-Wettk√§mpfe.

*Deployment-Zielarchitektur:*

----
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  arqua42.arc42.org                       ‚îÇ
‚îÇ                    (Custom Domain)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ HTTPS
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    fly.io Platform                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ  ‚îÇ      Aquarius App Container            ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  (Frontend + Backend + Static Files)   ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ                                         ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  Port 8080:                             ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ FastAPI Backend (/)                  ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ React Frontend (static build)        ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Static Assets (/static)              ‚îÇ             ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
‚îÇ             ‚îÇ                                            ‚îÇ
‚îÇ             ‚îÇ libSQL Protocol                            ‚îÇ
‚îÇ             ‚îÇ (over HTTP/WebSocket)                      ‚îÇ
‚îÇ             ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ  ‚îÇ         Turso Database                 ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ         (libSQL Cloud)                 ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ                                         ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Managed SQLite Database              ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Edge Replication (optional)          ‚îÇ             ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Automatic Backups                    ‚îÇ             ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
‚îÇ                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
----

==== 8.4.2 Technologie-Stack f√ºr Cloud Deployment

[cols="1,2,2"]
|===
|Komponente |Technologie |Begr√ºndung

|Container-Platform
|**fly.io**
|‚Ä¢ Einfaches Deployment mit `flyctl`
‚Ä¢ Automatisches HTTPS/TLS
‚Ä¢ Integriertes Load Balancing
‚Ä¢ Globale Edge-Locations
‚Ä¢ Kostenlose Tier f√ºr kleine Apps

|Datenbank
|**Turso (libSQL)**
|‚Ä¢ Managed SQLite-as-a-Service
‚Ä¢ SQLAlchemy-kompatibel √ºber libSQL-Treiber
‚Ä¢ Edge-Replication f√ºr niedrige Latenz
‚Ä¢ Automatische Backups
‚Ä¢ Kostenlose Tier (500 MB, 1 Mrd. Row Reads/Monat)

|Application Server
|**uvicorn**
|‚Ä¢ ASGI-Server f√ºr FastAPI
‚Ä¢ Hohe Performance
‚Ä¢ WebSocket-Support

|Static File Serving
|**FastAPI StaticFiles**
|‚Ä¢ Direkt aus Container
‚Ä¢ Alternative: fly.io Volumes f√ºr gr√∂√üere Mengen

|Domain & SSL
|**Custom Domain + fly.io SSL**
|‚Ä¢ arqua42.arc42.org
‚Ä¢ Automatische TLS-Zertifikate (Let's Encrypt)
|===

==== 8.4.3 Deployment-Architektur

===== Single-Region Deployment (Initial)

*Deployment-Region:* Frankfurt (fra) oder Amsterdam (ams) f√ºr niedrige Latenz in Deutschland/Europa

----
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          fly.io Region: fra              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ   Aquarius Instance        ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ   ‚Ä¢ 1 VM (shared-cpu-1x)   ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ   ‚Ä¢ 256 MB RAM             ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ   ‚Ä¢ 1 GB Disk              ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ                 ‚îÇ                         ‚îÇ
‚îÇ                 ‚îÇ libSQL/HTTP             ‚îÇ
‚îÇ                 ‚ñº                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ   Turso Database           ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ   ‚Ä¢ Primary Location: fra  ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ   ‚Ä¢ 500 MB Storage         ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
----

[NOTE]
====
*Skalierung f√ºr sp√§tere Phasen:*

* **Multi-Region Deployment:** Replicas in mehreren Regionen
* **Database Replication:** Turso Edge-Replicas f√ºr globale Verf√ºgbarkeit
* **Auto-Scaling:** Fly.io Autoscaling basierend auf Traffic
====

==== 8.4.4 Container-Strategie

===== Dockerfile-Architektur

*Multi-Stage Build f√ºr optimale Image-Gr√∂√üe:*

[source,dockerfile]
----
# Stage 1: Frontend Build
FROM node:20-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ ./
RUN npm run build

# Stage 2: Python Dependencies
FROM python:3.11-slim AS backend-builder
WORKDIR /app
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# Stage 3: Production Image
FROM python:3.11-slim
WORKDIR /app

# Copy Python dependencies
COPY --from=backend-builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=backend-builder /usr/local/bin /usr/local/bin

# Copy backend code
COPY backend/ ./backend/

# Copy built frontend
COPY --from=frontend-builder /app/frontend/dist ./frontend/dist

# Expose port
EXPOSE 8080

# Start application
CMD ["uvicorn", "backend.app.main:app", "--host", "0.0.0.0", "--port", "8080"]
----

===== Static File Serving

Frontend wird als **statische Build-Artefakte** in den Container integriert:

[source,python]
----
# backend/app/main.py (Cloud-Konfiguration)
import os
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from pathlib import Path

app = FastAPI()

# Serve React Frontend (Cloud)
if os.getenv("FLY_APP_NAME"):  # Production auf fly.io
    frontend_dist = Path(__file__).parent.parent.parent / "frontend" / "dist"

    # API routes unter /api
    app.include_router(router, prefix="/api")

    # Static assets (JS, CSS, Images)
    app.mount("/assets", StaticFiles(directory=str(frontend_dist / "assets")), name="assets")

    # Figuren-Bilder
    app.mount("/static", StaticFiles(directory=str(frontend_dist / "static")), name="static")

    # SPA fallback: Alle anderen Routes ‚Üí index.html
    @app.get("/{full_path:path}")
    async def serve_spa(full_path: str):
        return FileResponse(frontend_dist / "index.html")
----

==== 8.4.5 Datenbank-Migration: SQLite ‚Üí Turso

===== Turso Connection String

[source,python]
----
# backend/app/database.py
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# Cloud: Turso libSQL
# Local: SQLite File
DATABASE_URL = os.getenv(
    "DATABASE_URL",
    "sqlite:///./database/arqua42.db"  # Fallback f√ºr lokale Entwicklung
)

# Turso Format: libsql://[db-name]-[org].turso.io?authToken=...
engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False} if "sqlite" in DATABASE_URL else {},
    echo=False
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
----

===== Unterschiede SQLite vs. libSQL (Turso)

[cols="1,2,2"]
|===
|Aspekt |SQLite (lokal) |Turso (libSQL Cloud)

|Connection
|File-basiert
|HTTP/WebSocket

|Schema Migrations
|Alembic mit SQLite-Dialekt
|Alembic mit libSQL-Dialekt (kompatibel)

|Concurrency
|Write-Locks auf Datei
|Optimistic Locking in Cloud

|Backups
|Manuell (File-Copy)
|Automatisch (Turso)

|Replication
|Nicht verf√ºgbar
|Edge-Replicas verf√ºgbar
|===

[IMPORTANT]
====
*Kompatibilit√§t:* libSQL ist ein SQLite-Fork. Die meisten SQLAlchemy-Queries funktionieren ohne √Ñnderung.

*Nicht unterst√ºtzt:*

* `PRAGMA` Statements f√ºr Konfiguration
* WAL-Mode (wird von Turso verwaltet)
====

==== 8.4.6 Umgebungsvariablen und Secrets

===== fly.io Secrets Management

Secrets werden mit `flyctl secrets` verwaltet, **nicht** in `fly.toml`:

[source,bash]
----
# Turso Database URL mit Auth-Token
flyctl secrets set DATABASE_URL="libsql://aquarius-abc123.turso.io?authToken=eyJ..."

# Weitere Secrets (optional)
flyctl secrets set SECRET_KEY="$(openssl rand -base64 32)"
flyctl secrets set ADMIN_PASSWORD="..."
----

===== Umgebungsvariablen in fly.toml

[source,toml]
----
# fly.toml
app = "aquarius-production"
primary_region = "fra"

[build]
  dockerfile = "Dockerfile"

[env]
  # √ñffentliche Konfiguration (keine Secrets!)
  ENVIRONMENT = "production"
  LOG_LEVEL = "info"
  PORT = "8080"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1

[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 256
----

[WARNING]
====
*Niemals Secrets in `fly.toml` committen!*

Verwende immer `flyctl secrets set` f√ºr sensible Daten.
====

==== 8.4.7 Deployment-Workflow

===== Automatisches Deployment (CI/CD)

*GitHub Actions Workflow:*

[source,yaml]
----
name: Deploy to fly.io

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
----

===== Manuelles Deployment

[source,bash]
----
# 1. Login bei fly.io
flyctl auth login

# 2. App erstellen (einmalig)
flyctl launch --name aquarius-production --region fra

# 3. Secrets konfigurieren (einmalig)
flyctl secrets set DATABASE_URL="libsql://..."

# 4. Deploy durchf√ºhren
make deploy-to-fly

# 5. Status pr√ºfen
flyctl status
flyctl logs
----

==== 8.4.8 Makefile-Integration

[source,makefile]
----
.PHONY: deploy-to-fly
deploy-to-fly: ## Deploy application to fly.io
	@echo "üöÄ Deploying to fly.io..."
	@echo ""
	@echo "Prerequisites:"
	@echo "  - flyctl installed (brew install flyctl)"
	@echo "  - Logged in (flyctl auth login)"
	@echo "  - Secrets configured (flyctl secrets list)"
	@echo ""
	@read -p "Continue with deployment? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		flyctl deploy --remote-only; \
	else \
		echo "‚ùå Deployment cancelled"; \
		exit 1; \
	fi

.PHONY: deploy-status
deploy-status: ## Check fly.io deployment status
	@flyctl status
	@echo ""
	@flyctl logs --lines 50

.PHONY: deploy-logs
deploy-logs: ## Show fly.io application logs
	flyctl logs

.PHONY: deploy-ssh
deploy-ssh: ## SSH into fly.io container
	flyctl ssh console
----

==== 8.4.9 Custom Domain Konfiguration

===== DNS-Konfiguration f√ºr arqua42.arc42.org

[source,bash]
----
# 1. Zertifikat f√ºr Custom Domain erstellen
flyctl certs create arqua42.arc42.org

# 2. DNS CNAME-Eintrag bei Domain-Provider
# Name:   arqua42
# Type:   CNAME
# Value:  aquarius-production.fly.dev
# TTL:    300
----

*DNS-Propagation pr√ºfen:*

[source,bash]
----
dig arqua42.arc42.org
nslookup arqua42.arc42.org
----

===== Automatisches HTTPS/TLS

fly.io verwaltet TLS-Zertifikate automatisch via Let's Encrypt:

* Zertifikat wird bei erstem Request ausgestellt
* Automatische Renewal vor Ablauf
* HTTP ‚Üí HTTPS Redirect automatisch aktiv

==== 8.4.10 Monitoring und Logging

===== fly.io Monitoring

*Integrierte Metriken:*

* CPU/Memory Usage
* Request Count & Latency
* HTTP Status Codes
* Health Checks

[source,bash]
----
# Metriken anzeigen
flyctl metrics

# Live-Logs streamen
flyctl logs -a aquarius-production
----

===== Health Checks

[source,toml]
----
# fly.toml
[[services.http_checks]]
  interval = "30s"
  timeout = "5s"
  grace_period = "10s"
  method = "GET"
  path = "/api/health"

  [services.http_checks.headers]
    User-Agent = "fly-health-check"
----

[source,python]
----
# backend/app/main.py
@app.get("/api/health")
async def health_check():
    """Health check endpoint f√ºr fly.io"""
    return {
        "status": "healthy",
        "version": os.getenv("FLY_APP_VERSION", "unknown"),
        "database": await check_database_connection()
    }
----

===== Turso Database Monitoring

[source,bash]
----
# Turso CLI installieren
brew install tursodatabase/tap/turso

# Database Status
turso db show aquarius-production

# Query Statistics
turso db stats aquarius-production
----

==== 8.4.11 Backup und Disaster Recovery

===== Turso Automatic Backups

* **Point-in-Time Recovery:** Automatisch f√ºr letzte 24-48h
* **Manual Snapshots:** Vor gr√∂√üeren √Ñnderungen

[source,bash]
----
# Manual Backup erstellen
turso db dump aquarius-production --output backup.sql

# Restore aus Backup
turso db restore aquarius-production --from backup.sql
----

===== Container Volumes (f√ºr Figuren-Bilder)

*Optional: Persistentes Volume f√ºr Upload-Bilder:*

[source,toml]
----
# fly.toml
[mounts]
  source = "aquarius_data"
  destination = "/app/data"
----

[source,bash]
----
# Volume erstellen
flyctl volumes create aquarius_data --region fra --size 1

# Backup von Volume
flyctl ssh sftp get -r /app/data ./local-backup/
----

==== 8.4.12 Kosten-Kalkulation

===== fly.io Pricing (Stand 2024)

[cols="1,1,2"]
|===
|Ressource |Menge |Kosten/Monat

|**Shared CPU VM**
|1x (256 MB RAM)
|~$3-5

|**Persistentes Volume**
|1 GB
|~$0.15

|**Outbound Traffic**
|~10 GB
|Inkludiert

|**Custom Domain + SSL**
|1 Domain
|Kostenlos
|===

*Gesch√§tzte Gesamtkosten:* **$5-10 / Monat** f√ºr kleine bis mittlere Nutzung

===== Turso Pricing

[cols="1,1,2"]
|===
|Tier |Limits |Kosten

|**Free Tier**
|‚Ä¢ 500 MB Storage
‚Ä¢ 1 Mrd. Row Reads
‚Ä¢ 100 Mio. Row Writes
|$0

|**Starter**
|‚Ä¢ 5 GB Storage
‚Ä¢ 10 Mrd. Row Reads
‚Ä¢ 1 Mrd. Row Writes
|~$29
|===

[NOTE]
====
*F√ºr Aquarius-Wettkampfsystem:* Free Tier ist ausreichend f√ºr:

* ~20.000 Kinder-Registrierungen
* ~100 Wettk√§mpfe/Jahr
* ~500.000 Bewertungs-Eintr√§ge

*Upgrade n√∂tig bei:* >50 Wettk√§mpfe/Jahr mit >200 Teilnehmern
====

==== 8.4.13 Sicherheitsaspekte

===== Transport Security

* **TLS 1.3:** Automatisch durch fly.io
* **HSTS:** Strict-Transport-Security Header
* **Certificate Pinning:** Optional f√ºr Mobile Apps

===== Database Security

* **Encrypted Connections:** libSQL √ºber HTTPS/WSS
* **Authentication Token:** Turso Auth Token in Secrets
* **Row-Level Security:** Zuk√ºnftig via Turso RLS

[source,python]
----
# backend/app/main.py
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware

if os.getenv("ENVIRONMENT") == "production":
    # Force HTTPS
    app.add_middleware(HTTPSRedirectMiddleware)

    # Restrict to trusted hosts
    app.add_middleware(
        TrustedHostMiddleware,
        allowed_hosts=["arqua42.arc42.org", "*.fly.dev"]
    )
----

===== Secrets Rotation

[source,bash]
----
# Turso Token rotieren
turso db tokens create aquarius-production

# Neuen Token in fly.io setzen
flyctl secrets set DATABASE_URL="libsql://...?authToken=NEW_TOKEN"

# Deployment triggern
flyctl deploy
----

==== 8.4.14 Migrations-Strategie

===== Schema Migrations mit Alembic

[source,bash]
----
# Lokale Migration testen
cd backend
alembic upgrade head

# Cloud Migration durchf√ºhren (manuell)
flyctl ssh console
cd /app/backend
alembic upgrade head
----

[IMPORTANT]
====
*Zero-Downtime Migrations:*

1. **Backward-Compatible Changes:** Neue Spalten als nullable
2. **Blue-Green Deployment:** Alte Version l√§uft w√§hrend Migration
3. **Rollback-Plan:** Jede Migration muss `downgrade()` haben
====

===== Automatische Migrations im Container

[source,dockerfile]
----
# Dockerfile (Production)
CMD ["sh", "-c", "cd backend && alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8080"]
----

[WARNING]
====
*Risiko bei Auto-Migrations:*

* Container-Restart kann fehlschlagen bei Migration-Fehler
* **Empfehlung:** Manuell vor Deployment ausf√ºhren
====

==== 8.4.15 Rollback-Strategie

===== fly.io Release Management

[source,bash]
----
# Releases anzeigen
flyctl releases

# Rollback zur vorherigen Version
flyctl releases rollback

# Rollback zu spezifischer Version
flyctl releases rollback --version v123
----

===== Database Rollback

[source,bash]
----
# Alembic Downgrade (lokal testen!)
alembic downgrade -1

# Im Notfall: Turso Point-in-Time Restore
turso db restore aquarius-production --timestamp "2024-01-15T10:00:00Z"
----

==== 8.4.16 Entwicklungs-Workflow

===== Lokale Entwicklung mit Turso

[source,bash]
----
# Turso CLI installieren
brew install tursodatabase/tap/turso

# Turso Auth Token holen
turso db tokens create aquarius-dev

# In .env setzen
DATABASE_URL="libsql://aquarius-dev.turso.io?authToken=..."

# App starten
make dev
----

===== Staging-Environment

[source,bash]
----
# Separate Staging-App auf fly.io
flyctl launch --name aquarius-staging --region fra

# Staging-Database bei Turso
turso db create aquarius-staging --location fra

# Deployment nach Staging
flyctl deploy -a aquarius-staging
----

*Deployment-Pipeline:*

----
Local Dev ‚Üí Staging ‚Üí Production
   ‚Üì           ‚Üì          ‚Üì
SQLite     Turso      Turso
           (staging)  (production)
----

==== 8.4.17 Offene Punkte und n√§chste Schritte

[cols="1,2,1"]
|===
|Aufgabe |Beschreibung |Status

|**Dockerfile erstellen**
|Multi-Stage Build mit Frontend + Backend
|‚è≥ TODO

|**fly.toml konfigurieren**
|App-Config f√ºr fly.io
|‚è≥ TODO

|**Turso Database einrichten**
|Production + Staging Datenbanken
|‚è≥ TODO

|**Secrets konfigurieren**
|DATABASE_URL in fly.io Secrets
|‚è≥ TODO

|**Makefile-Target**
|`make deploy-to-fly` implementieren
|‚è≥ TODO

|**DNS konfigurieren**
|CNAME f√ºr arqua42.arc42.org
|‚è≥ TODO

|**Health Checks**
|`/api/health` Endpoint implementieren
|‚è≥ TODO

|**CI/CD Pipeline**
|GitHub Actions Workflow
|‚è≥ TODO
|===

[NOTE]
====
*Dokumentations-Referenzen:*

* fly.io Docs: https://fly.io/docs/
* Turso Docs: https://docs.turso.tech/
* libSQL Python Client: https://github.com/libsql/libsql-client-py
====
